<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Platform v3.0 - Premium Suite</title>

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --bg-body: #eef2f5;
            --bg-panel: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- LAYOUT --- */
        .left-panel {
            width: 320px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.03);
            z-index: 100;
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: var(--bg-body);
            padding: 20px;
        }

        .right-panel {
            width: 250px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.03);
            z-index: 100;
        }

        /* --- MODULES --- */
        .module {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .module:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .module h3 {
            margin: 0 0 16px 0;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- MAP CONTAINER --- */
        #map-container {
            width: 100%;
            height: 100%;
            max-width: 85vh;
            max-height: 85vh;
            border: 10px solid white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            aspect-ratio: 1/1;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #cbd5e0;
        }

        /* --- TOOLBARS --- */
        .map-toolbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 16px;
            border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tool-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: var(--secondary);
            color: white;
        }

        .tool-btn.danger {
            color: var(--accent);
        }

        .tool-btn.danger:hover {
            background: var(--accent);
            color: white;
        }

        /* --- FORM ELEMENTS --- */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            background: #f8fafc;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .action-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: var(--primary-dark);
        }

        .action-btn.secondary {
            background: #95a5a6;
        }

        .action-btn.danger {
            background: var(--accent);
        }

        .file-upload-box {
            border: 2px dashed #cbd5e0;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            margin-bottom: 12px;
        }

        .file-upload-box:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: white;
        }

        /* --- LAYER CONTROLS --- */
        .layer-group {
            margin-bottom: 28px;
        }

        .layer-group h4 {
            margin: 0 0 12px 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            font-size: 0.9rem;
            gap: 12px;
        }

        .layer-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* --- NOTIFICATIONS --- */
        #notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* --- LOADING --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>

<body>
    <!-- SIDEBAR IZQUIERDA -->
    <div class="left-panel">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="font-size: 1.5rem; margin: 0; color: var(--secondary);">GisSuite <span
                    style="color: var(--primary);">Pro</span></h1>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin: 4px 0 0 0;">PLATAFORMA INTEGRAL CATASTRAL
                v3.0</p>
        </div>

        <div class="module">
            <h3><i class="fa-solid fa-magnifying-glass"></i> Buscador Catastral</h3>
            <input type="text" id="ref-input" placeholder="Referencia Catastral (20 car.)">
            <button class="action-btn" onclick="buscarReferencia()">
                <i class="fa-solid fa-search"></i> Iniciar An√°lisis
            </button>
            <div id="busqueda-resultados" style="margin-top: 12px; font-size: 0.85rem; display: none;"></div>
        </div>

        <div class="module">
            <h3><i class="fa-solid fa-layer-group"></i> Lote de Referencias</h3>
            <div class="file-upload-box" onclick="document.getElementById('lote-input').click()">
                <i class="fa-solid fa-file-csv" style="font-size: 1.5rem; display: block; margin-bottom: 8px;"></i>
                <span>Cargar TXT / CSV</span>
            </div>
            <input type="file" id="lote-input" style="display: none;" accept=".txt,.csv"
                onchange="handleLoteFile(this)">
            <div id="lote-status" style="font-size: 0.8rem; color: var(--text-muted);"></div>
        </div>

        <div class="module">
            <h3><i class="fa-solid fa-map-location-dot"></i> Descarga Municipal</h3>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="municipio-input" placeholder="Nombre Municipio" style="margin-bottom: 0;">
                <button class="action-btn" style="width: 50px;" onclick="buscarMunicipios()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
            <div id="municipios-box" style="margin-top: 12px; max-height: 150px; overflow-y: auto;"></div>
        </div>

        <div class="module">
            <h3><i class="fa-solid fa-chart-line"></i> An√°lisis Espacial</h3>
            <button class="action-btn secondary" onclick="document.getElementById('file-analisis').click()">
                <i class="fa-solid fa-upload"></i> Subir Geometr√≠a
            </button>
            <input type="file" id="file-analisis" style="display: none;" accept=".kml,.geojson,.json"
                onchange="handleAnalisisFile(this)">
            <div id="analisis-status" style="margin-top: 10px; font-size: 0.85rem;"></div>
        </div>

        <div class="module">
            <h3><i class="fa-solid fa-file-pdf"></i> Generar Informe</h3>
            <button class="action-btn danger" onclick="abrirModalPDF()">
                <i class="fa-solid fa-print"></i> Configurar PDF
            </button>
        </div>
    </div>

    <!-- PANEL CENTRAL - MAPA -->
    <div class="center-panel">
        <div id="map-container">
            <div class="map-toolbar">
                <button class="tool-btn" onclick="activaMedicion('distancia')" title="Medir Distancia">
                    <i class="fa-solid fa-ruler"></i>
                </button>
                <button class="tool-btn" onclick="activaMedicion('area')" title="Medir √Årea">
                    <i class="fa-solid fa-draw-polygon"></i>
                </button>
                <button class="tool-btn danger" onclick="limpiarMapa()" title="Limpiar Mapa">
                    <i class="fa-solid fa-trash"></i>
                </button>
                <div id="medicion-info"
                    style="font-size: 0.8rem; font-weight: 600; padding: 0 10px; display: flex; align-items: center; border-left: 1px solid #ddd; margin-left: 5px;">
                </div>
            </div>
            <div id="map"></div>
        </div>
        <button class="action-btn"
            style="width: auto; margin-top: 24px; padding: 12px 32px; border-radius: 30px; background: var(--secondary);"
            onclick="centrarVista()">
            <i class="fa-solid fa-crosshairs"></i> Centrar Vista Selecci√≥n
        </button>
    </div>

    <!-- SIDEBAR DERECHA - CAPAS -->
    <div class="right-panel">
        <div class="layer-group">
            <h4>Fondo de Mapa</h4>
            <div class="layer-item">
                <input type="radio" name="base-layer" id="base-osm" checked onchange="switchBaseLayer('osm')">
                <label for="base-osm">Callejero (OSM)</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="base-layer" id="base-sat" onchange="switchBaseLayer('satelite')">
                <label for="base-sat">Sat√©lite (Google)</label>
            </div>
        </div>

        <div class="layer-group">
            <h4>Infraestructura Catastral</h4>
            <div class="layer-item">
                <input type="checkbox" id="layer-catastro" checked onchange="toggleOverlay('catastro', this.checked)">
                <label for="layer-catastro">Parcelario Catastral</label>
            </div>
            <div style="padding-left: 30px; margin-top: -5px;">
                <input type="range" id="opacidad-catastro" min="0" max="100" value="80"
                    style="width: 100%; height: 4px;" oninput="cambiarOpacidad('catastro', this.value)">
                <small style="font-size: 0.7rem; color: var(--text-muted);">Opacidad: <span
                        id="val-opacidad">80</span>%</small>
            </div>
        </div>

        <div class="layer-group">
            <h4>Afecciones de Riesgo</h4>
            <div class="layer-item">
                <input type="checkbox" id="layer-zonasinundables"
                    onchange="toggleOverlay('zonasinundables', this.checked)">
                <div class="layer-color" style="background: #F44336"></div>
                <label for="layer-zonasinundables">Zonas Inundables</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-masasagua" onchange="toggleOverlay('masasagua', this.checked)">
                <div class="layer-color" style="background: #0288D1"></div>
                <label for="layer-masasagua">Masas de Agua</label>
            </div>
        </div>

        <div class="layer-group">
            <h4>Medio Ambiente</h4>
            <div class="layer-item">
                <input type="checkbox" id="layer-rednatura" onchange="toggleOverlay('rednatura', this.checked)">
                <div class="layer-color" style="background: #2E7D32"></div>
                <label for="layer-rednatura">Red Natura 2000</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-espaciosnaturales"
                    onchange="toggleOverlay('espaciosnaturales', this.checked)">
                <div class="layer-color" style="background: #1976D2"></div>
                <label for="layer-espaciosnaturales">Espacios Protegidos</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-viaspocuarias" onchange="toggleOverlay('viaspocuarias', this.checked)">
                <div class="layer-color" style="background: #F57C00"></div>
                <label for="layer-viaspocuarias">V√≠as Pecuarias</label>
            </div>
        </div>
    </div>

    <!-- MODAL PDF -->
    <div id="modal-pdf" class="modal">
        <div class="modal-content">
            <h2
                style="margin: 0 0 24px 0; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 12px;">
                <i class="fa-solid fa-file-pdf"></i> Configuraci√≥n de Informe T√©cnico
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Titular/Empresa:</label>
                    <input type="text" id="pdf-empresa" placeholder="GisSuite Pro SL" style="margin-bottom: 0;">
                </div>
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Colegiado N¬∫:</label>
                    <input type="text" id="pdf-colegiado" placeholder="ID-45678" style="margin-bottom: 0;">
                </div>
            </div>
            <div id="pdf-checklist"
                style="background: #f1f5f9; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                <p style="text-align: center; color: var(--text-muted); margin: 0;">Espera a seleccionar una parcela
                    para activar contenidos.</p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="action-btn secondary" style="width: auto; padding: 12px 24px;"
                    onclick="cerrarModalPDF()">Cancelar</button>
                <button class="action-btn danger" id="btn-generar-pdf" style="width: auto; padding: 12px 24px;" disabled
                    onclick="generarInformes()">Generar Documento</button>
            </div>
        </div>
    </div>

    <!-- UI COMPONENTS -->
    <div id="notification"></div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="font-weight: 600; color: var(--secondary);">Procesando datos geogr√°ficos...</p>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="/static/js/viewer.js"></script>

    <script>
        // ====================================================================
        // VARIABLES GLOBALES Y MOTOR GIS
        // ====================================================================
        let gisViewer;
        let measureLayer = L.featureGroup();
        let currentDraw;
        let drawnItems = new L.FeatureGroup();

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando Hub GIS v3.0...');

            // Inicializar motor core (viewer.js)
            gisViewer = new GISViewer('map');
            gisViewer.map.addLayer(measureLayer);
            gisViewer.map.addLayer(drawnItems);

            // Inyectar controles de dibujo de Leaflet
            initDrawEngine();
        });

        // ====================================================================
        // GESTI√ìN DE MAPA BASE Y CAPAS
        // ====================================================================
        function switchBaseLayer(type) {
            const map = gisViewer.map;
            // Capas base ya definidas en viewer.js o aqu√≠ localmente
            if (type === 'satelite') {
                if (!window.satLayer) window.satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
                map.addLayer(window.satLayer);
            } else {
                if (window.satLayer) map.removeLayer(window.satLayer);
            }
            console.log('‚úÖ Cambio de base layer:', type);
        }

        function toggleOverlay(id, visible) {
            gisViewer.toggleLayer(id, visible);
        }

        function cambiarOpacidad(id, val) {
            document.getElementById('val-opacidad').textContent = val;
            const layer = gisViewer.layers[id];
            if (layer) layer.setOpacity(val / 100);
        }

        // ====================================================================
        // M√ìDULO: B√öSQUEDA CATASTRAL
        // ====================================================================
        async function buscarReferencia() {
            const ref = document.getElementById('ref-input').value.trim().toUpperCase();
            if (!ref) return showNotification('Introduce una referencia v√°lida', 'warning');

            showLoading(`Analizando parcela: ${ref}`);
            const resBox = document.getElementById('busqueda-resultados');
            resBox.style.display = 'block';
            resBox.innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:10px auto;"></div>';

            try {
                // 1. Obtener Geometr√≠a usando el endpoint correcto
                const geoRes = await fetch(`/api/v1/catastro/geometria/${ref}?formatos=geojson`);
                const geoData = await geoRes.json();

                if (geoData.status === 'error' || !geoData.geojson) {
                    throw new Error(geoData.error || 'No se encontr√≥ geometr√≠a');
                }

                // Procesar GeoJSON y a√±adir al mapa
                const geoJsonData = typeof geoData.geojson === 'string' 
                    ? JSON.parse(geoData.geojson) 
                    : geoData.geojson;

                // Limpiar previo y a√±adir
                drawnItems.clearLayers();
                const layer = L.geoJSON(geoJsonData, {
                    style: { color: '#e74c3c', weight: 3, fillOpacity: 0.1 }
                }).addTo(drawnItems);

                gisViewer.map.fitBounds(layer.getBounds(), { padding: [50, 50] });

                // 2. Obtener datos catastrales completos
                const datosRes = await fetch(`/api/v1/catastro/datos/${ref}`);
                const datosData = await datosRes.json();

                // 3. Procesar an√°lisis de afecciones
                const afeccionesRes = await fetch('/api/v1/catastro/afecciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        referencia: ref,
                        capas_analizar: ['rednatura', 'viaspocuarias', 'espaciosnaturales', 'zonasinundables', 'masasagua']
                    })
                });

                const afeccionesData = await afeccionesRes.json();

                // 4. Mostrar resultados completos
                showNotification('‚úÖ An√°lisis completado con √©xito', 'success');
                
                const resultados = {
                    coordenadas: datosData.coordenadas || true,
                    parcela_gml: true,
                    pdf_oficial: datosData.pdf_oficial || true,
                    plano_ortofoto: true,
                    informe_pdf: afeccionesData.informe ? true : false,
                    afecciones: afeccionesData.afecciones || []
                };

                renderChecklist(resultados, ref);
                document.getElementById('btn-generar-pdf').disabled = false;

                // Mostrar resumen de afecciones
                if (afeccionesData.afecciones && afeccionesData.afecciones.length > 0) {
                    const afeccionesHtml = afeccionesData.afecciones.map(a => 
                        `<li style="margin-bottom:4px; font-size:0.8rem;">
                            <strong>${a.tipo}:</strong> ${a.porcentaje_afectado}% (${a.area_afectada}m¬≤)
                        </li>`
                    ).join('');
                    
                    resBox.innerHTML += `
                        <div style="margin-top:12px; padding:8px; background:#f1f5f9; border-radius:8px;">
                            <strong style="font-size:0.85rem;">Afecciones detectadas:</strong>
                            <ul style="margin:4px 0; padding-left:16px;">
                                ${afeccionesHtml}
                            </ul>
                        </div>
                    `;
                }

            } catch (e) {
                console.error('Error en b√∫squeda:', e);
                resBox.innerHTML = `<p style="color:var(--accent); font-weight:600;">‚ùå Error: ${e.message}</p>`;
                showNotification(`Error: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function renderChecklist(res, referencia) {
            const box = document.getElementById('busqueda-resultados');
            let html = '<ul style="list-style:none; padding:0; margin:0;">';
            const items = [
                { k: 'coordenadas', l: 'Coordenadas UTM' },
                { k: 'parcela_gml', l: 'Parcela GML' },
                { k: 'pdf_oficial', l: 'PDF Catastro' },
                { k: 'plano_ortofoto', l: 'Plano Ortofoto' },
                { k: 'informe_pdf', l: 'Informe Pre-An√°lisis' }
            ];

            items.forEach(i => {
                html += `<li style="margin-bottom:4px; display:flex; align-items:center; gap:8px;">
                    <i class="fa-solid ${res[i.k] ? 'fa-check-circle text-success' : 'fa-times-circle'}" style="color:${res[i.k] ? '#4CAF50' : '#cbd5e0'}"></i>
                    <span>${i.l}</span>
                </li>`;
            });
            html += '</ul>';
            html += `<button class="action-btn" onclick="descargarCompleto('${referencia}')" style="margin-top:12px;">
                <i class="fa-solid fa-file-zipper"></i> Descargar Documentaci√≥n
            </button>`;
            box.innerHTML = html;
        }

        async function descargarCompleto(referencia) {
            try {
                showLoading('Preparando documentaci√≥n...');
                
                const res = await fetch('/api/v1/catastro/procesar-lote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        referencias: [referencia],
                        capas_analizar: ['rednatura', 'viaspocuarias', 'espaciosnaturales']
                    })
                });

                const data = await res.json();
                if (data.status === 'success' && data.lote_id) {
                    window.open(`/api/v1/catastro/descargar/${data.lote_id}`, '_blank');
                    showNotification('‚úÖ Documentaci√≥n descargada', 'success');
                } else {
                    throw new Error('Error generando documentaci√≥n');
                }
            } catch (e) {
                showNotification(`Error: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ====================================================================
        // M√ìDULO: LOTE DE REFERENCIAS
        // ====================================================================
        function handleLoteFile(input) {
            const file = input.files[0];
            if (!file) return;

            const statusBox = document.getElementById('lote-status');
            statusBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cargando archivo...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                const refs = content.split(/[\n,]/).map(r => r.trim().toUpperCase()).filter(r => r.length >= 14);

                if (refs.length === 0) {
                    statusBox.innerHTML = '<span style="color:var(--accent);">No se han detectado referencias v√°lidas.</span>';
                    return;
                }

                statusBox.innerHTML = `<strong>${refs.length}</strong> referencias encontradas. <button class="action-btn" onclick='iniciarProcesamientoLote(${JSON.stringify(refs)})' style="padding:4px 8px; font-size:11px; margin-top:5px;">Procesar Lote</button>`;
            };
            reader.readAsText(file);
        }

        async function iniciarProcesamientoLote(refs) {
            showLoading(`Procesando lote de ${refs.length} referencias...`);
            try {
                const res = await fetch('/api/v1/catastro/procesar-lote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referencias: refs, capas_analizar: ['rednatura', 'viaspocuarias'] })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showNotification('‚úÖ Lote procesado con √©xito', 'success');
                    window.open(data.zip_path || data.url, '_blank');
                } else {
                    throw new Error(data.error || 'Error en el servidor');
                }
            } catch (e) {
                showNotification(`Error: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ====================================================================
        // M√ìDULO: AN√ÅLISIS ESPACIAL
        // ====================================================================
        function handleAnalisisFile(input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('analisis-status');
            status.innerHTML = `<i class="fa-solid fa-file"></i> ${file.name}<br><button class="action-btn secondary" onclick="subirYAnalizar()" style="margin-top:5px;">Ejecutar Afecciones</button>`;
        }

        async function subirYAnalizar() {
            const fileInput = document.getElementById('file-analisis');
            if (!fileInput.files[0]) return;

            showLoading('Analizando geometr√≠a...');
            
            try {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Leer y procesar archivo
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        let geometria;
                        const content = e.target.result;

                        if (file.name.endsWith('.geojson') || file.name.endsWith('.json')) {
                            geometria = JSON.parse(content);
                        } else if (file.name.endsWith('.kml')) {
                            // Convertir KML a GeoJSON (simplificado)
                            geometria = { type: "FeatureCollection", features: [] };
                        }

                        if (geometria && geometria.features) {
                            // A√±adir al mapa
                            drawnItems.clearLayers();
                            const layer = L.geoJSON(geometria, {
                                style: { color: '#3498db', weight: 2, fillOpacity: 0.2 }
                            }).addTo(drawnItems);

                            gisViewer.map.fitBounds(layer.getBounds());

                            // Analizar afecciones
                            const afeccionesRes = await fetch('/api/v1/analisis/afecciones', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    geometria_wkt: JSON.stringify(geometria.features[0].geometry)
                                })
                            });

                            const afeccionesData = await afeccionesRes.json();
                            
                            if (afeccionesData.afecciones) {
                                const afeccionesHtml = afeccionesData.afecciones.map(a => 
                                    `<div style="margin-bottom:8px; padding:8px; background:#f8fafc; border-radius:6px;">
                                        <strong>${a.tipo_capa}:</strong> ${a.porcentaje_afectado}% afectado (${a.area_afectada}m¬≤)
                                    </div>`
                                ).join('');
                                
                                document.getElementById('analisis-status').innerHTML = `
                                    <div style="margin-top:10px;">
                                        <strong>‚úÖ An√°lisis completado</strong>
                                        ${afeccionesHtml}
                                    </div>
                                `;
                            }
                        }

                        hideLoading();
                        showNotification('‚úÖ An√°lisis completado', 'success');
                    } catch (error) {
                        hideLoading();
                        showNotification(`Error procesando archivo: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);

            } catch (error) {
                hideLoading();
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // ====================================================================
        // M√ìDULO: MUNICIPIOS
        // ====================================================================
        async function buscarMunicipios() {
            const query = document.getElementById('municipio-input').value.trim();
            const box = document.getElementById('municipios-box');
            box.innerHTML = '<p style="text-align:center;font-size:0.8rem;">Buscando...</p>';

            try {
                const res = await fetch(`/api/v1/buscar-municipio?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (data.municipios && data.municipios.length > 0) {
                    box.innerHTML = data.municipios.map(m => `
                        <div style="padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:6px; cursor:pointer;" onclick="window.open('${m.url}', '_blank')">
                            <strong style="font-size:0.85rem;">${m.nombre}</strong><br>
                            <small style="color:var(--primary); font-size:0.75rem;">Descargar Inspire ZIP</small>
                        </div>
                    `).join('');
                } else {
                    box.innerHTML = '<p style="font-size:0.8rem;color:var(--accent);">No se han encontrado resultados.</p>';
                }
            } catch (e) {
                box.innerHTML = '<p style="font-size:0.8rem;color:var(--accent);">Error de conexi√≥n.</p>';
            }
        }

        // ====================================================================
        // HERRAMIENTAS DE MEDICI√ìN (SIMULACI√ìN CAD)
        // ====================================================================
        let activeMeasureMode = null;
        let measurePoints = [];

        function activaMedicion(modo) {
            activeMeasureMode = modo;
            measurePoints = [];
            measureLayer.clearLayers();
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tool-btn[onclick*="${modo}"]`).classList.add('active');

            gisViewer.map.getContainer().style.cursor = 'crosshair';
            showNotification(`Modo medici√≥n: ${modo.toUpperCase()} (Haz clic en el mapa)`, 'info');
        }

        function limpiarMapa() {
            drawnItems.clearLayers();
            measureLayer.clearLayers();
            measurePoints = [];
            activeMeasureMode = null;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            gisViewer.map.getContainer().style.cursor = '';
            document.getElementById('medicion-info').textContent = '';
        }

        function initDrawEngine() {
            gisViewer.map.on('click', (e) => {
                if (!activeMeasureMode) return;

                measurePoints.push(e.latlng);
                L.circleMarker(e.latlng, { radius: 4, color: '#2c3e50', fillOpacity: 1 }).addTo(measureLayer);

                if (activeMeasureMode === 'distancia' && measurePoints.length > 1) {
                    L.polyline(measurePoints, { color: '#3498db', weight: 3 }).addTo(measureLayer);
                    let dist = 0;
                    for (let i = 0; i < measurePoints.length - 1; i++) dist += measurePoints[i].distanceTo(measurePoints[i + 1]);
                    document.getElementById('medicion-info').innerHTML = `<i class="fa-solid fa-ruler"></i> ${dist.toFixed(2)} m`;
                }

                if (activeMeasureMode === 'area' && measurePoints.length > 2) {
                    measureLayer.eachLayer(l => { if (l instanceof L.Polygon) measureLayer.removeLayer(l); });
                    L.polygon(measurePoints, { color: '#3498db', fillOpacity: 0.2 }).addTo(measureLayer);
                    let area = calcularAreaPoligonal(measurePoints);
                    document.getElementById('medicion-info').innerHTML = `<i class="fa-solid fa-draw-polygon"></i> ${area.toFixed(2)} m¬≤`;
                }
            });

            // Doble click para cerrar medici√≥n
            gisViewer.map.on('dblclick', () => {
                if (activeMeasureMode) activaMedicion(null);
            });
        }

        function calcularAreaPoligonal(latlngs) {
            // Algoritmo Shoelace simplificado
            let area = 0;
            const RADIUS = 6378137;
            const d2r = Math.PI / 180;

            for (let i = 0; i < latlngs.length; i++) {
                let p1 = latlngs[i];
                let p2 = latlngs[(i + 1) % latlngs.length];
                area += ((p2.lng - p1.lng) * d2r) * (2 + Math.sin(p1.lat * d2r) + Math.sin(p2.lat * d2r));
            }
            return Math.abs(area * RADIUS * RADIUS / 2.0);
        }

        // ====================================================================
        // GESTI√ìN DE PDF
        // ====================================================================
        async function generarInformes() {
            const ref = document.getElementById('ref-input').value.trim();
            if (!ref) return showNotification('No hay parcela seleccionada', 'warning');

            const empresa = document.getElementById('pdf-empresa').value || 'GisSuite Pro';
            const colegiado = document.getElementById('pdf-colegiado').value || 'ID-0000';

            showLoading('Generando documento t√©cnico...');
            try {
                const res = await fetch('/api/v1/generar-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        referencia: ref,
                        empresa: empresa,
                        colegiado: colegiado,
                        contenidos: ['datos_descriptivos', 'capas_afecciones', 'contorno_superpuesto']
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showNotification('‚úÖ Informe generado correctamente', 'success');
                    window.open(data.url, '_blank');
                    cerrarModalPDF();
                } else {
                    throw new Error(data.error || 'Error generando PDF');
                }
            } catch (e) {
                showNotification(`Error: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ====================================================================
        // UTILS UI
        // ====================================================================
        function abrirModalPDF() { document.getElementById('modal-pdf').style.display = 'flex'; }
        function cerrarModalPDF() { document.getElementById('modal-pdf').style.display = 'none'; }
        function showNotification(msg, type) { gisViewer.showNotification(msg, type); }
        function showLoading(msg) { gisViewer.showLoading(msg); }
        function hideLoading() { gisViewer.hideLoading(); }
        function centrarVista() {
            if (drawnItems.getLayers().length > 0) gisViewer.map.fitBounds(drawnItems.getBounds());
            else showNotification('No hay elementos para centrar', 'warning');
        }

    </script>
</body>

</html>