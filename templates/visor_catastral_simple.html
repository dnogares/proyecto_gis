<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visor Catastral</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .controls input {
      margin: 5px;
      padding: 5px;
      width: 200px;
    }
    .controls button {
      margin: 5px;
      padding: 5px 10px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h3>üè† Visor KKtastral</h3>
    <div>
      <input type="text" id="refInput" placeholder="Referencia catastral" />
      <button onclick="cargarReferencia()">Cargar</button>
    </div>
    <div>
      <button onclick="cargarCapas()">üîÑ Cargar Capas</button>
    <div id="capasList"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
  <script>
    let map = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      map = L.map('map').setView([40.0, -3.7], 6);
      
      // Capa base minimalista (solo referencia)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap',
        maxZoom: 19,
        opacity: 0.3  // Muy transparente para que resalten las capas locales
      }).addTo(map);
      
      // Cargar capas locales autom√°ticamente
      cargarCapasLocales();
    });
    
    async function cargarCapasLocales() {
      try {
        const response = await fetch('/api/v1/capas/fgb');
        const capas = await response.json();
        
        console.log('üó∫Ô∏è Capas locales encontradas:', capas.length);
        
        // Definir categor√≠as y capas espec√≠ficas a buscar
        const categoriasCapas = {
          'V√≠as Pecuarias': ['pecuaria', 'via', 'ganadera', 'trashumancia'],
          'Montes P√∫blicos': ['monte', 'forestal', 'publico', 'demanio'],
          'Red Natura 2000': ['rednatura', 'natura', 'rn2000', 'ps.rnatura'],
          'Espacio Hidr√°ulico Protegido': ['agua', 'rio', 'costa', 'hidraulico', 'embalse', 'cuenca'],
          'Zonas Inundables': ['inundable', 'inundacion', 'avenida', 'riada'],
          'Riesgo S√≠smico': ['sismico', 'sismo', 'terremoto', 'seismic'],
          'Riesgo Desertificaci√≥n': ['desertificacion', 'desert', 'arido', 'erosion'],
          'Riesgo Volc√°nico': ['volcan', 'volcanico', 'lava', 'ceniza'],
          'Bienes de Inter√©s Cultural': ['bic', 'cultural', 'patrimonio', 'monumento', 'historico'],
          'IGN Base': ['ign', 'base', 'cartografia', 'mtn']
        };
        
        // Buscar y cargar capas por categor√≠as
        Object.entries(categoriasCapas).forEach(([categoria, keywords]) => {
          const capasCategoria = capas.filter(capa => 
            keywords.some(keyword => 
              capa.archivo.toLowerCase().includes(keyword.toLowerCase()) ||
              (capa.nombre && capa.nombre.toLowerCase().includes(keyword.toLowerCase()))
            )
          );
          
          if (capasCategoria.length > 0) {
            console.log(`üìÇ ${categoria}: ${capasCategoria.length} capas`);
            capasCategoria.forEach(capa => {
              cargarCapaFlatGeobuf(capa, categoria);
            });
          }
        });
        
        // Actualizar lista en el UI organizada por categor√≠as
        actualizarListaCapasPorCategorias(capas, categoriasCapas);
        
      } catch (error) {
        console.error('‚ùå Error cargando capas locales:', error);
      }
    }
    
    async function cargarCapaFlatGeobuf(capa, categoria = 'General') {
      try {
        console.log(`üìÇ Cargando capa: ${capa.archivo} (${categoria})`);
        
        const response = await fetch(capa.url);
        const arrayBuffer = await response.arrayBuffer();
        
        // Usar FlatGeobuf para leer los datos
        const features = [];
        const it = flatgeobuf.deserialize(new Uint8Array(arrayBuffer));
        for await (const feature of it) {
          features.push(feature);
        }
        
        // Crear capa GeoJSON y a√±adirla al mapa
        const geoJsonLayer = L.geoJSON(features, {
          style: function(feature) {
            return {
              fillColor: getColorForCategoria(categoria),
              weight: 2,
              opacity: 0.8,
              color: getColorForCategoria(categoria),
              fillOpacity: 0.3
            };
          },
          onEachFeature: function(feature, layer) {
            if (feature.properties) {
              const popupContent = Object.entries(feature.properties)
                .slice(0, 5)  // Primeras 5 propiedades
                .map(([key, value]) => `<b>${key}:</b> ${value}`)
                .join('<br>');
              layer.bindPopup(`<b>${categoria}</b><br><b>${capa.nombre || capa.archivo}</b><br>${popupContent}`);
            }
          }
        }).addTo(map);
        
        console.log(`‚úÖ Capa cargada: ${capa.archivo} (${features.length} elementos) - ${categoria}`);
        
      } catch (error) {
        console.error(`‚ùå Error cargando ${capa.archivo}:`, error);
      }
    }
    
    function getColorForCategoria(categoria) {
      const colors = {
        'V√≠as Pecuarias': '#8B4513',      // Marr√≥n
        'Montes P√∫blicos': '#228B22',     // Verde bosque
        'Red Natura 2000': '#2ECC71',     // Verde esmeralda
        'Espacio Hidr√°ulico Protegido': '#3498DB',  // Azul agua
        'Zonas Inundables': '#5DADE2',    // Azul claro
        'Riesgo S√≠smico': '#E74C3C',      // Rojo
        'Riesgo Desertificaci√≥n': '#F39C12', // Naranja
        'Riesgo Volc√°nico': '#8B0000',     // Rojo oscuro
        'Bienes de Inter√©s Cultural': '#9B59B6', // P√∫rpura
        'IGN Base': '#7F8C8D',            // Gris
        'General': '#95A5A6'              // Gris por defecto
      };
      
      return colors[categoria] || colors['General'];
    }
    
    function actualizarListaCapasPorCategorias(capas, categoriasCapas) {
      const capasList = document.getElementById('capasList');
      if (!capasList) return;
      
      let html = '<h4>üó∫Ô∏è Capas por Categor√≠as:</h4>';
      
      // Mostrar capas organizadas por categor√≠as
      Object.entries(categoriasCapas).forEach(([categoria, keywords]) => {
        const capasCategoria = capas.filter(capa => 
          keywords.some(keyword => 
            capa.archivo.toLowerCase().includes(keyword.toLowerCase()) ||
            (capa.nombre && capa.nombre.toLowerCase().includes(keyword.toLowerCase()))
          )
        );
        
        if (capasCategoria.length > 0) {
          const color = getColorForCategoria(categoria);
          html += `
            <div style="margin: 10px 0; padding: 8px; border-left: 4px solid ${color}; background: rgba(0,0,0,0.05);">
              <strong style="color: ${color};">${categoria}</strong> (${capasCategoria.length})
              <div style="margin-left: 10px; margin-top: 5px;">
          `;
          
          capasCategoria.forEach(capa => {
            html += `
              <div style="margin: 3px 0;">
                <label style="font-size: 12px;">
                  <input type="checkbox" checked onchange="toggleCapa('${capa.archivo}', this.checked)">
                  ${capa.nombre || capa.archivo}
                </label>
              </div>
            `;
          });
          
          html += '</div></div>';
        }
      });
      
      // A√±adir capas sin categorizar
      const capasSinCategoria = capas.filter(capa => {
        return !Object.values(categoriasCapas).some(keywords =>
          keywords.some(keyword => 
            capa.archivo.toLowerCase().includes(keyword.toLowerCase()) ||
            (capa.nombre && capa.nombre.toLowerCase().includes(keyword.toLowerCase()))
          )
        );
      });
      
      if (capasSinCategoria.length > 0) {
        html += `
          <div style="margin: 10px 0; padding: 8px; border-left: 4px solid #95A5A6; background: rgba(0,0,0,0.05);">
            <strong style="color: #95A5A6;">Otras Capas</strong> (${capasSinCategoria.length})
            <div style="margin-left: 10px; margin-top: 5px;">
        `;
        
        capasSinCategoria.forEach(capa => {
          html += `
            <div style="margin: 3px 0;">
              <label style="font-size: 12px;">
                <input type="checkbox" onchange="toggleCapa('${capa.archivo}', this.checked)">
                ${capa.nombre || capa.archivo}
              </label>
            </div>
          `;
        });
        
        html += '</div></div>';
      }
      
      capasList.innerHTML = html;
    }
    
    async function toggleCapa(archivo, activar) {
      if (activar) {
        // Buscar la capa y cargarla
        try {
          const response = await fetch('/api/v1/capas/fgb');
          const capas = await response.json();
          const capa = capas.find(c => c.archivo === archivo);
          if (capa) {
            await cargarCapaFlatGeobuf(capa);
          }
        } catch (error) {
          console.error('Error toggling capa:', error);
        }
      }
      // TODO: Implementar remover capa si se desactiva
    }
    
    async function cargarReferencia() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral');
        return;
      }
      
      try {
        const response = await fetch(`/api/v1/referencia/${encodeURIComponent(ref)}/geojson`);
        if (!response.ok) {
          alert('Referencia no encontrada');
          return;
        }
        
        const geojson = await response.json();
        
        L.geoJSON(geojson, {
          style: {
            color: '#e74c3c',
            weight: 3,
            fillOpacity: 0.3
          }
        }).addTo(map);
        
        // Centrar mapa en la referencia
        const bounds = L.geoJSON(geojson).getBounds();
        map.fitBounds(bounds);
        
      } catch (error) {
        console.error('Error cargando referencia:', error);
        alert('Error cargando referencia');
      }
    }

    async function cargarCapas() {
      // Esta funci√≥n ahora carga las capas locales
      await cargarCapasLocales();
    }

    async function cargarCapaIndividual(url) {
      try {
        const response = await fetch(url);
        const geojson = await response.json();
        L.geoJSON(geojson, {
          style: { color: '#3b82f6', weight: 2, fillOpacity: 0.3 }
        }).addTo(map);
      } catch (e) {
        console.error('Error:', e);
        alert('Error cargando capa');
      }
    }
  </script>
</body>
</html>
