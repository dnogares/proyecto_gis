<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visor Catastral</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .controls input {
      margin: 5px;
      padding: 5px;
      width: 200px;
    }
    .controls button {
      margin: 5px;
      padding: 5px 10px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h3>üè† Visor KKtastral</h3>
    <div>
      <input type="text" id="refInput" placeholder="Referencia catastral" />
      <button onclick="cargarReferencia()">Cargar</button>
    </div>
    <div>
      <button onclick="cargarCapas()">üîÑ Cargar Capas</button>
    <div id="capasList"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // Variable global para el mapa
    let map;
    let drawnItems;

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Inicializar el mapa con seguridad
        map = L.map('map').setView([40.4167, -3.7033], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // 2. Configurar herramientas de dibujo
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: { polygon: true, polyline: false, rectangle: true, circle: false, marker: false }
        });
        map.addControl(drawControl);

        // SOLUCI√ìN AL ERROR 'ON' de null: El evento se asigna DESPU√âS de crear el mapa
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers(); // Limpiar dibujos previos
            const layer = e.layer;
            drawnItems.addLayer(layer);
            
            // Aqu√≠ llamar√≠amos a la funci√≥n de an√°lisis que vimos antes
            const geometria = layer.toGeoJSON().geometry;
            console.log("Geometr√≠a lista para analizar:", geometria);
        });

        console.log("‚úÖ Mapa y controles de dibujo listos");
        
        // Cargar la lista de capas autom√°ticamente
        await cargarListaCapas();
    });

    // 2. SOLUCI√ìN AL ERROR 'Unexpected token g' (Lectura binaria de FGB)
    async function cargarCapaIndividual(nombre, url) {
        console.log(`ÔøΩ Descargando binario FGB: ${nombre}`);
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Error en la descarga");

            // IMPORTANTE: flatgeobuf.deserialize espera el body de la respuesta
            const iter = flatgeobuf.deserialize(response.body);
            
            const fgLayer = L.geoJSON(null, {
                style: { color: '#3b82f6', weight: 2, fillOpacity: 0.3 },
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`<b>Capa:</b> ${nombre}`);
                }
            }).addTo(map);

            // Leemos el stream binario
            for await (let feature of iter) {
                fgLayer.addData(feature);
            }
            
            console.log(`‚úÖ Capa ${nombre} renderizada con √©xito`);
            map.fitBounds(fgLayer.getBounds());

        } catch (error) {
            console.error("‚ùå Fallo cr√≠tico cargando FGB:", error);
            alert("El archivo no es un JSON v√°lido, pero el cargador binario tambi√©n fall√≥. Revisa la consola.");
        }
    }

    async function cargarListaCapas() {
        const res = await fetch('/api/v1/capas/fgb');
        const data = await res.json();
        const container = document.getElementById('capasList'); // Aseg√∫rate de que este ID existe
        
        if (data.capas) {
            data.capas.forEach(capa => {
                const btn = document.createElement('button');
                btn.className = "btn-capa";
                btn.innerHTML = `<span>üìÅ</span> ${capa.nombre}`;
                btn.onclick = () => cargarCapaIndividual(capa.nombre, capa.url);
                container.appendChild(btn);
            });
        }
    }

    async function cargarReferencia() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral');
        return;
      }
      
      try {
        const response = await fetch(`/api/v1/referencia/${encodeURIComponent(ref)}/geojson`);
        if (!response.ok) {
          alert('Referencia no encontrada');
          return;
        }
        
        const geojson = await response.json();
        
        L.geoJSON(geojson, {
          style: {
            color: '#e74c3c',
            weight: 3,
            fillOpacity: 0.3
          }
        }).addTo(map);
        
        // Centrar mapa en la referencia
        const bounds = L.geoJSON(geojson).getBounds();
        map.fitBounds(bounds);
        
      } catch (error) {
        console.error('Error cargando referencia:', error);
        alert('Error cargando referencia');
      }
    }

    async function cargarCapas() {
      // Esta funci√≥n ahora carga las capas locales
      await cargarListaCapas();
    }
  </script>
</body>
</html>
